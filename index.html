<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Natu Helados</title>

    <link rel="stylesheet" href="./styles.css">

    <!-- CSP estricta -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:;">
</head>

<body>

<div class="contenedor-principal">
    <h1>
        <a href="#" id="abrir-modal" style="text-decoration: none; color: inherit;">N</a>atu Helados 
    </h1>
    
    <h2>* Ice Cream ***</h2>

    <!-- Filtros -->
    <div class="filtros" id="filtros-container">
        <button class="filtro-btn active" data-grupo="Todos">üç¶ TODOS</button>
        <button class="filtro-btn" data-grupo="Cremoso">üç® CREMOSOS</button>
        <button class="filtro-btn" data-grupo="FullCremoso">üéÇ FULL CREMOSOS</button>
        <button class="filtro-btn" data-grupo="Premium">‚≠ê PREMIUM</button>
    </div>

    <div id="catalogo" class="catalogo"></div>

    <!-- Contenedor para la lista en el cuadrante IV -->
    <div id="lista-seleccionados" style="position: fixed; bottom: 20px; right: 20px; width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 10px; overflow-y: auto; max-height: 300px;">
        <h3>
          <a href="#" id="calcular-total" style="text-decoration: none; color: inherit;">S</a>eleccionados
        </h3>
        <ul id="lista-productos" style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem;"></ul>
    </div>

    <!-- Modal para la Tasa BCV -->
    <div id="modal-bcv" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); padding: 20px; z-index: 1000; width: 300px; text-align: center;">
        <label for="tasa-bcv" style="display: block; margin-bottom: 10px; font-weight: bold;">Tasa BCV</label>
        <input type="text" id="tasa-bcv" style="width: 100%; padding: 8px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;">
        <button id="grabar-tasa-btn" style="width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">Grabar</button>
        <button id="cerrar-modal-btn" style="width: 100%; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Cerrar</button>
    </div>
</div>

<!-- ================= SCRIPT UNIFICADO ================= -->
<script>
// =================== LISTA DE PRODUCTOS ===================
const productos = [
    {id:1, nombre:"PARCHITA CREMOSA", grupo:"Cremoso", stock:1, imagen:"./outputs/small/parchitacremosa_400.webp"},
    {id:2, nombre:"PI√ëA CREMOSA", grupo:"Cremoso", stock:1, imagen:"./outputs/small/pi√±acremosa_400.webp"},
    {id:3, nombre:"DURAZNO CREMOSO", grupo:"Cremoso", stock:1, imagen:"./outputs/small/duraznocremoso_400.webp"},
    {id:4, nombre:"FRESA", grupo:"Cremoso", stock:1, imagen:"./outputs/small/fresa_400.webp"},
    {id:5, nombre:"GUANA-GUANA", grupo:"FullCremoso", stock:1, imagen:"./outputs/small/guanaguana_400.webp"},
    {id:6, nombre:"OREO CREMITA", grupo:"FullCremoso", stock:1, imagen:"./outputs/small/oreocremita_400.webp"},
    {id:7, nombre:"PIE PARCHITA", grupo:"FullCremoso", stock:1, imagen:"./outputs/small/pieparchita_400.webp"},
    {id:8, nombre:"PIE NARANJA", grupo:"FullCremoso", stock:1, imagen:"./outputs/small/pienaranja_400.webp"},
    {id:0, nombre:"11-VAINILLA, 10-DALMATA, 9-CHOCO OREO", grupo:"Premium", stock:1, imagen:"./outputs/small/pastelados_400.webp"}
];

// =================== VARIABLES ===================
const listaSeleccionados = [];
const precioTipo = { "Cremoso":0.5, "FullCremoso":0.7, "Premium":1.0, "Ninguno":0.3 };
const productosConStock = productos.filter(p=>p.stock>0);

// =================== FUNCIONES ===================

// Render lista seleccionados
function renderListaSeleccionados(){
    const ul = document.getElementById("lista-productos");
    ul.innerHTML="";
    listaSeleccionados.forEach((p,i)=>{
        const li = document.createElement("li");
        li.textContent = `#${p.id} - ${p.nombre}`;
        const btn = document.createElement("button");
        btn.textContent="Eliminar";
        btn.style.marginLeft="10px";
        btn.style.background="#ff4d4d";
        btn.style.color="white";
        btn.style.border="none";
        btn.style.borderRadius="5px";
        btn.style.cursor="pointer";
        btn.addEventListener("click", ()=>{
            listaSeleccionados.splice(i,1);
            renderListaSeleccionados();
        });
        li.appendChild(btn);
        ul.appendChild(li);
    });
}

// Calcular total
function calcularTotal(){
    if(listaSeleccionados.length===0){
        alert("Total: $0\nTotal Bs: 0");
        return;
    }
    let total=0;
    listaSeleccionados.forEach(p=>total+=precioTipo[p.grupo]||0);
    const tasa=parseFloat(localStorage.getItem('tasa'))||0;
    const totalBs=total*tasa;
    alert(`Total: $${total.toFixed(2)}\nTotal Bs: ${totalBs.toFixed(2)}`);
}

// Modal
function mostrarModal(){
    const tasa = localStorage.getItem('tasa')||'';
    document.getElementById('tasa-bcv').value=tasa;
    document.getElementById('modal-bcv').style.display='block';
}
function cerrarModal(){ document.getElementById('modal-bcv').style.display='none'; }
function grabarTasa(){
    const tasa = document.getElementById('tasa-bcv').value;
    localStorage.setItem('tasa', tasa);
    alert(`Tasa BCV grabada: ${tasa}`);
    cerrarModal();
}

// Asignar eventos a las im√°genes
function asignarEventosImagenes(productosMostrados){
    document.querySelectorAll(".imagen-container img").forEach((img,index)=>{
        img.addEventListener("click",()=>{
            const p = productosMostrados[index];
            listaSeleccionados.push({id:p.id,nombre:p.nombre,grupo:p.grupo});
            renderListaSeleccionados();
        });
    });
}

// Renderizar cat√°logo
function renderCatalogo(grupo){
    const catalogo = document.getElementById("catalogo");
    catalogo.innerHTML="";
    const productosFiltrados = grupo==="Todos"?productosConStock:productosConStock.filter(p=>p.grupo===grupo);
    productosFiltrados.forEach(p=>{
        const div = document.createElement("div");
        div.className="imagen-container";
        div.innerHTML=`<img src="${p.imagen}" alt="${p.nombre}" style="width:100px;height:100px;cursor:pointer;"><div>${p.nombre}</div>`;
        catalogo.appendChild(div);
    });
    asignarEventosImagenes(productosFiltrados);
}

// =================== EVENT LISTENERS ===================
document.getElementById("abrir-modal").addEventListener("click",mostrarModal);
document.getElementById("cerrar-modal-btn").addEventListener("click",cerrarModal);
document.getElementById("grabar-tasa-btn").addEventListener("click",grabarTasa);
document.getElementById("calcular-total").addEventListener("click",calcularTotal);

// Filtros
document.querySelectorAll(".filtro-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
        document.querySelectorAll(".filtro-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        renderCatalogo(btn.dataset.grupo);
    });
});

// Inicializar cat√°logo completo
renderCatalogo("Todos");

// Bloqueo men√∫ contextual
document.addEventListener("contextmenu",e=>e.preventDefault());

</script>
</body>
</html>
